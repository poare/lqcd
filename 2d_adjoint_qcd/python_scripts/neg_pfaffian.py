# Investigating a sample with a negative Pfaffian

import numpy as np
import h5py
import os
import time
import multiprocessing

from pfapack import pfaffian

import sys
sys.path.append('/Users/theoares/lqcd/utilities')
import formattools as fmt

import rhmc

state = ('MT19937', np.array([3074782246, 1747317631, 1371699167, 1572946898, 2927788531,
        726136004, 3601711183, 2124672596, 3512002462, 1541051867,
       1571569470, 4072063289,  221106732, 2935013033, 4170047280,
        884011013, 1269709588, 2094375348, 3409673012,  115259858,
       3681469335, 1264342493, 2428330138, 3960541049, 3162507932,
       2263127374, 1624489519, 1668980556, 4012620353, 2908332001,
       2585902882, 3162283193, 3563530619, 1939095617, 1932428172,
        854530115, 4281565329, 4004512324, 1157591137, 1179602070,
        454281214,  395791036, 1710856638,   38419719, 4153206750,
        239394405, 2499130609, 1708689277, 3272908893, 3930599127,
       3581881055,  647155197, 3123923573, 2971145602, 1835066799,
       2871862283, 3101446627,   82039417, 2176598923,   35148901,
       3316904550, 2499330520,  660705896, 3237372068, 2739278858,
       3655078977, 3117244605, 2540379701, 2402414104,  547278266,
        756789808, 3172347946, 1797069523, 2654450049,  715217121,
       1528128252, 3110935059,  294147135, 2058189443, 4251077780,
       2008097129, 3412906015, 1568792419, 3291041796, 4000868257,
       3583444985, 3277685419, 3786914996, 3520060336,  995236507,
        987308743,  545053560, 3957386933, 4010802525, 2900360764,
       1337267345, 2011849034,  785946553, 2133159781, 2886321110,
       1248231376, 3559643475, 2766256392, 2078633793, 1412736924,
       2157515120, 1015231301, 2625540664,  439024135, 3572749171,
       1314200451,  308487620, 1260082161, 3193181323, 3448452721,
       3019733172, 1070483525, 1762380951, 3883588139, 1332589919,
       1949516597, 3252518810, 3487884482, 2248589745, 2320737597,
       2596578742, 3345546860, 2085458466, 2795908102, 1870794251,
       1896050866,  950454003, 1399458579, 3650371803,  873789279,
        379512289,  723902787, 4028940432, 3298558977,  786032728,
        913506313, 1504947384, 2756711082, 2440077691, 2633199262,
       1133232023, 3164451156, 3301267736, 1292323617, 1308164499,
       1133436368, 2538186744, 1374726771, 2263842366, 2529932893,
       4024379664, 2583170048, 1848935442, 3938279240,  181559349,
       3973310985, 3893276070, 2643920154, 2507802041, 3067721292,
       3097236446, 2399440888, 3024669443, 2549271314,  870824756,
       3024570383, 1080861012, 1894621367, 4164000409, 2960600494,
       3371065168, 1474009544, 3061669179, 4113359780, 2410159726,
       2525980267, 3725308226, 1461115223, 3791336409, 3499209227,
       3150427479, 3997166001, 1688878395, 2572284959,   54197471,
        419033891,  545816698, 1278918170, 3940173069, 3577529556,
       3345598233, 3043198895, 2714714308,  142084031, 2281669471,
       4020562540, 2382772957, 2927270968, 1365820037, 4232579796,
       2422819259, 1174158601,  436674197,   29621729, 1348863884,
       2074062401, 2614480635, 2154315293, 2854002017,  608782321,
        712861953, 2441587625, 1810686171, 3596524003, 1859170865,
       2074794047, 4000414728, 3822863995,   95457550, 2303021807,
        291636388,  501089580, 2353590329, 2367616638,  101691630,
        786256445,  630551519, 1459679393,  372714354,  987957590,
        307979294, 2977871531, 3375043181, 2959021299, 2092413151,
       3509907026, 4294133337,  152488907, 3249358624, 1595645765,
       2616660440, 3451494132, 2198586021, 2797341224, 1019316245,
       1517124956,  531005994,  841896096, 3917047157, 3038897937,
       2966367165, 2344573369, 4058281795, 2136478844, 3169988457,
       1574745096, 2530893450, 2295946348,  981130265, 2985936991,
       3611898333, 1892213102,  875772124, 4266021494, 2302146489,
       2793344365,  900436574,  960954405,  437027142,  661365798,
        609736801,  912202154, 1423132042,  769113120, 1208112852,
       4062638436, 2153658168, 2473980250, 1218684608, 2058696846,
       1256618016, 4278099333, 2385014258, 3875566829, 1733595675,
       2007843772, 2200774066, 3896091094, 2782278420, 1046114956,
        795208446, 1720950667, 2578838938, 2020181044, 2545243409,
       2022739322,  408363025,  880519466, 4068727852, 2995881837,
       2767386012,   59016684, 3819672576, 2987932025, 3229418559,
       1840428713, 3550084768, 2794260490,  416304514, 2522040869,
        900286168, 2707464346, 1218302674,  166677617, 2883914740,
       2835901658, 2317920082,  933312750, 3137324240, 1126031961,
       1275246070, 1247292018, 4078935258, 1115952849, 3210449735,
       1487635568,  880395865, 2872175246, 4118983477, 1606757050,
       1949347642, 1221931191, 2578030585, 2016858119, 2969864926,
       1282875318, 2049467239, 1604405286,  919057371, 4078224118,
       3401872760, 4073322727,  424005616,  304751209, 4129595407,
       4136644077,   41552207, 2257321480, 3231183245, 2215181273,
       1382678643, 3539771240, 1299290985, 4120956818, 3426430922,
       3338688785, 3061859313,  142093407,  886773905, 1801670546,
       4225742309, 1859287915, 2195543872, 3464311809,  114193173,
       1332472599, 3457815222, 3603332600, 2874258911, 1139206651,
       1311152136, 1697892301, 1806877592, 1192798911, 3207965349,
       2598076854,    1549482, 4214745832, 4183361829, 2484019769,
       2854464646, 1751161783,  241243887, 3460705957, 3776605877,
       2836757988,   78645585, 4127535077, 1481800082, 4289975772,
       1470407044, 2611159142,  221293984, 3433657502, 1644887594,
       2347820585, 1793830272, 2667442762, 1098707644, 3434435150,
       1295238222,  678163076,  416801165, 3602415278, 3554630344,
       3415998338, 2049250692, 1877499248, 1848985854, 2359347657,
       2741973771, 1198338646, 1404524992, 3532956742, 2154712666,
       2132342429,  884821282, 4010943330, 3500038363, 3722328747,
       2126655990, 3743946988,  785336723,  605562474, 3055718023,
       1403585043, 1074470035, 4056695131,  257365101, 4180927459,
       2187070872, 2805098151,   47995198,  704340581, 3071065384,
       3211691139, 4206231872,  870547892, 1199062518, 3387104609,
       4044530107, 3354597321,  771322787, 3411377884, 1756603472,
       1503423356, 2487398054, 2700290943, 2230420168, 1027190668,
       1867394771, 2592083205, 2804298181, 3029620598, 4077345464,
        116314297, 1133507860, 2887178777, 3265446552, 2333635090,
       2425893470,  749032177, 2042440111, 1271257197,  412506192,
       2636249088,    4466721, 3200466913, 3738669829, 1575957227,
        853634350, 1314518450, 3575329460, 1302378128, 2856754717,
       3379900525, 3367101694,  817861869,  865469636, 2844482335,
        789828744, 1698348491, 3683080740, 3859235657, 1643722999,
       2658193401, 3428663126,  220666889,  238785608, 1847338236,
       2979379601, 2119812697,  534311004, 3399467175,  903540534,
        181560312, 2879274304, 1926809398, 2154877364, 2832974612,
        612467931, 3004727919, 1405254116, 2429221492, 2934694158,
       1563127815, 1265794776, 3852962465,  862379351,  480883290,
       4002496086, 1390110173,  620886475, 2399428299, 4195252471,
       2715092583, 2212191780,  795145722, 1763481102, 2157706515,
       1900641807, 3513256131, 2884416360, 1017834030,  238132925,
       1518049810, 1591763086,  966291422, 2429679498, 2219640412,
        991918793, 3649920151,  750604340,  975625356, 3688150050,
       1963330236, 1313148598,  426018708, 2946410061,    7082131,
       2434008211, 3233859193, 2581505456,  998506543, 1248864114,
       1694342771,  312964567, 1516395609, 3014440560, 2655722588,
       4089795067, 2098788541, 1888316523, 3447591733,  503262379,
       2085065108, 1755693822, 2145849893,  821961823,  311756912,
       3015968110, 4142171190, 2081204055, 2680897450,  437043070,
       2738427598,   59754547, 3948623992, 2215992240, 2149342258,
        391556669, 1561831442, 1007533603, 2801180205, 2957468960,
       2933583493, 2096919180,  972082630,  417460012,  492501581,
       2552534634, 1937252382, 3838540179,  195959845, 2321990100,
       1496048248, 2996989853, 4079427481, 3699755548,  886227328,
       2273771888, 3273868448, 3239217140, 1609254570, 2767183766,
       1401111812, 3254264293, 4064719371, 4195068730,  553565915,
       1621621111,  452946108, 1987294390, 3779101891, 2397188248,
        612921403, 1042491785, 2330270785,  897433481, 1993869365,
        602365061, 1511379907, 1158246222, 3486907780, 2969699030,
       2217233556, 3378267972, 1800590808, 3221330549], dtype = np.uint32), 396, 0, 0.0)
np.random.set_state(state)

Nc = 2
kappa = 0.2
bcs = (1, -1)
gens = rhmc.get_generators(Nc)
Lat = rhmc.Lattice(4, 4)

U = rhmc.gen_random_fund_field(Nc, lat = Lat)
V = rhmc.construct_adjoint_links(U, gens, lat = Lat)
D = rhmc.dirac_op_sparse(kappa, V, bcs = bcs, lat = Lat)
Q = rhmc.hermitize_dirac(D)
pf = rhmc.pfaffian(Q)

# pfa_pf = pfaffian.pfaffian(np.asmatrix(Q))
pfa_pf = pfaffian.pfaffian(Q.toarray())

print('Config 1')
print(f'Value of Pfaffian from my algorithm: {pf}.')
print(f'Value of Pfaffian from pfapack: {pfa_pf}.')


U = rhmc.gen_random_fund_field(Nc, lat = Lat)
V = rhmc.construct_adjoint_links(U, gens, lat = Lat)
D = rhmc.dirac_op_sparse(kappa, V, bcs = bcs, lat = Lat)
Q = rhmc.hermitize_dirac(D)
pf = rhmc.pfaffian(Q)

# pfa_pf = pfaffian.pfaffian(np.asmatrix(Q))
pfa_pf = pfaffian.pfaffian(Q.toarray())

print('\nConfig 2')
print(f'Value of Pfaffian from my algorithm: {pf}.')
print(f'Value of Pfaffian from pfapack: {pfa_pf}.')